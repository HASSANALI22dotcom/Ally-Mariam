<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè° Ukoo wa ALLY NDOILE MKILINDI</title>
<meta name="description" content="App ya kusimamia mti wa familia ya ALLY NDOILE MKILINDI. Onyesha vizazi vyote vya familia kwa mtindo wa mti: wanaukoo, wajukuu, wanafamilia wote, pamoja na mahusiano ya ndoa (spouse). Upload photo kwa kila mwanaukoo, tuma ujumbe wa mawasiliano, angalia stats za familia (idadi ya wanaukoo, wajukuu), na chunguza mawasiliano ya mtandaoni. App hii ni PWA tayari kwa offline, inasaidia caching kupitia service worker, na inaweza kuinstall kama app kwenye simu au desktop.">
<meta name="theme-color" content="#166534">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
<link rel="shortcut icon" href="assets/favicon.ico">

<style>
body { font-family:'Georgia', serif; background:#f3f4f6; color:#1f2937; margin:0; padding:0; }
.container { max-width:1200px; margin:auto; padding:20px; }
h1,h2 { text-align:center; }
form { background:white; padding:20px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); margin-bottom:30px; }
form input, form select, form button { padding:10px; margin:5px 0; width:100%; border-radius:6px; border:1px solid #d1d5db; }
form button { background:#166534; color:white; cursor:pointer; border:none; transition:0.3s; }
form button:hover { background:#1e40af; }
#tree-container { text-align:center; margin-bottom:30px; }
.tree-node { background:#f3f4f6; border:2px solid #166534; border-radius:10px; padding:10px 15px; min-width:140px; text-align:center; position:relative; margin:auto; }
.tree-node .avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(45deg,#166534,#1e40af); color:white; display:flex; align-items:center; justify-content:center; margin:0 auto 5px; font-weight:bold; object-fit:cover; }
.tree-children { display:flex; justify-content:center; gap:20px; margin-top:15px; flex-wrap:wrap; }
.stats { display:flex; justify-content:center; gap:20px; margin-top:20px; }
.stat-card { background:white; padding:15px; border-radius:10px; text-align:center; box-shadow:0 3px 6px rgba(0,0,0,0.1); min-width:100px; }
#communication { background:white; padding:20px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); margin-top:30px; }
#messages { border:1px solid #ccc; padding:10px; height:150px; overflow-y:auto; background:white; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
<h1>üè° Ukoo wa ALLY NDOILE MKILINDI</h1>

<form id="signup-form">
<h2>üìù Jiandikishe Mwanaukoo</h2>
<input type="text" id="name" placeholder="Jina Kamili" required>
<input type="text" id="spouse" placeholder="Jina la Mume/Mke (optional)">
<select id="role" required>
<option value="">Chagua Nafasi</option>
<option value="Baba">Baba</option>
<option value="Mama">Mama</option>
<option value="Mtoto">Mtoto</option>
</select>
<select id="parent" required>
<option value="">Chagua mzazi / parent</option>
</select>
<input type="file" id="photo" accept="image/*">
<button type="submit">‚ûï Ongeza Mwanaukoo</button>
</form>

<div class="stats">
<div class="stat-card"><span id="total-members">0</span><br>Wanafamilia</div>
<div class="stat-card"><span id="total-grandchildren">0</span><br>Wajukuu</div>
</div>

<section id="tree">
<h2>üå≥ Mti wa Familia</h2>
<div id="tree-container"></div>
</section>

<section id="communication">
<h2>üì± Mawasiliano</h2>
<div id="messages"></div>
<input type="text" id="msgInput" placeholder="Andika ujumbe..." style="width:80%; padding:10px;">
<button id="sendMsgBtn" style="padding:10px;">Tuma</button>
<button onclick="alert('Call feature bado haijashikilia backend!')">Piga Simu</button>
</section>
</div>

<script>
// ===== IndexedDB Setup =====
let db;
const request = indexedDB.open("ukooDB", 1);
request.onupgradeneeded = function(event) {
  db = event.target.result;
  db.createObjectStore("members", { keyPath: "id" }).createIndex("name", "name", { unique:false });
  db.createObjectStore("messages", { keyPath: "time" });
};
request.onsuccess = function(event){ db=event.target.result; loadMembers(); loadMessages(); updateStatsDB(); };
request.onerror = function(event){ console.error("IndexedDB error:", event.target.errorCode); };

// ===== Family Tree Functions =====
function addMemberToDB(member){ const tx=db.transaction("members","readwrite"); const store=tx.objectStore("members"); store.put(member); tx.oncomplete=()=>{ renderTreeFromDB(); updateStatsDB(); }; }
function loadMembers(){ const tx=db.transaction("members","readonly"); const store=tx.objectStore("members"); store.getAll().onsuccess=()=>{ renderTreeFromDB(); updateStatsDB(); }; }
function renderTreeFromDB(){ const tx=db.transaction("members","readonly"); const store=tx.objectStore("members"); store.getAll().onsuccess=e=>{ const members=e.target.result; const treeContainer=document.getElementById('tree-container'); treeContainer.innerHTML=''; const root=members.find(m=>m.role==="Mzazi Mkuu"); if(root) treeContainer.appendChild(createNode(root,members)); }; }
function createNode(member,allMembers){ const node=document.createElement('div'); node.classList.add('tree-node'); const avatarHTML=member.photo?`<img src="${member.photo}" alt="${member.name}" class="avatar">`:`<div class="avatar">${member.name[0]}</div>`; node.innerHTML=`${avatarHTML}<strong>${member.name}</strong><br><small>${member.role}</small>${member.spouse?`<br><small>Ameolewa/Ameoa: ${member.spouse}</small>`:''}<div class="tree-children"></div>`; const childrenContainer=node.querySelector('.tree-children'); const children=allMembers.filter(m=>m.parentId===member.id); children.forEach(child=>childrenContainer.appendChild(createNode(child,allMembers))); return node; }

// ===== Stats =====
function updateStatsDB(){ const tx=db.transaction("members","readonly"); const store=tx.objectStore("members"); store.getAll().onsuccess=e=>{ const members=e.target.result; document.getElementById('total-members').innerText=members.length; const grandchildrenCount=members.reduce((acc,m)=>{ const children=members.filter(c=>c.parentId===m.id); acc+=children.reduce((cAcc,cChild)=>{ cAcc+=members.filter(g=>g.parentId===cChild.id).length; return cAcc; },0); return acc; },0); document.getElementById('total-grandchildren').innerText=grandchildrenCount; }; }

// ===== Add New Member =====
document.getElementById('signup-form').addEventListener('submit',function(e){
e.preventDefault(); const name=document.getElementById('name').value.trim(); const spouse=document.getElementById('spouse').value.trim(); const role=document.getElementById('role').value; const parentId=parseInt(document.getElementById('parent').value); const photoFile=document.getElementById('photo').files[0]; const photoURL=photoFile?URL.createObjectURL(photoFile):null; if(!name||!role||(role!=="Mzazi Mkuu"&&!parentId)) return alert("Jaza taarifa zote"); const newMember={id:Date.now(), name, role, spouse, parentId:role==="Mzazi Mkuu"?null:parentId, photo:photoURL}; addMemberToDB(newMember); this.reset(); updateParentOptionsDB(); });

// ===== Parent Dropdown =====
function updateParentOptionsDB(){ const parentSelect=document.getElementById('parent'); parentSelect.innerHTML='<option value="">Chagua mzazi / parent</option>'; const tx=db.transaction("members","readonly"); const store=tx.objectStore("members"); store.getAll().onsuccess=e=>{ const members=e.target.result; function addOptions(member,prefix=''){ parentSelect.innerHTML+=`<option value="${member.id}">${prefix}${member.name} (${member.role})</option>`; const children=members.filter(m=>m.parentId===member.id); children.forEach(c=>addOptions(c,prefix+'--')); } const root=members.find(m=>m.role==="Mzazi Mkuu"); if(root) addOptions(root); }; }

// ===== Chat Messages =====
function loadMessages(){ const tx=db.transaction("messages","readonly"); const store=tx.objectStore("messages"); store.getAll().onsuccess=e=>{ const msgs=e.target.result; const messagesDiv=document.getElementById(messagesDiv.innerHTML=''; 
    msgs.sort((a,b)=>a.time-b.time); // sort by time
    msgs.forEach(msgObj=>{
        const div=document.createElement('div');
        div.style.padding="5px"; div.style.marginBottom="5px"; div.style.background="#e5e7eb"; div.style.borderRadius="5px";
        div.textContent="You: "+msgObj.text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // auto scroll
    });
}

document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
    const msgInput=document.getElementById('msgInput');
    const msg=msgInput.value.trim();
    if(!msg) return;
    const tx=db.transaction("messages","readwrite");
    const store=tx.objectStore("messages");
    store.put({time:Date.now(), text:msg});
    tx.oncomplete=()=> loadMessages();
    msgInput.value="";
});

// ===== Initial Load =====
document.addEventListener('DOMContentLoaded', ()=>{
    updateParentOptionsDB();
    loadMembers();
    loadMessages();
});
</script>

<script>
// ===== Service Worker Registration =====
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js')
    .then(()=>console.log('‚úÖ Service Worker Registered'))
    .catch(err=>console.error('‚ùå SW registration failed:',err));
}
</script>

</body>
</html>
